---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const allPosts = await getCollection("posts", ({ data }) => {
        return import.meta.env.PROD ? data.draft !== true : true;
    });

    const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts
            .filter((post) => post.data.tags?.includes(tag))
            .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout title={`Tag: #${tag}`} description={`Posts marcados com ${tag}`}>
    <section>
        <h1 class="font-bold text-2xl mb-8">
            <span class="text-rose-500">#</span>{tag}
        </h1>
        
        <ul class="flex flex-col gap-6 list-none p-0">
            {posts.map((post) => (
                <li class="flex flex-col">
                    <div class="flex justify-between items-baseline gap-4 w-full">
                        <a 
                            href={`/blog/${post.id}/`} 
                            class="
                                text-lg font-medium
                                text-gray-900 dark:text-gray-100
                                hover:text-rose-500 dark:hover:text-rose-400
                                hover:underline decoration-1 underline-offset-2
                            "
                        >
                            {post.data.title}
                        </a>

                        <time 
                            datetime={post.data.date.toISOString()} 
                            class="text-sm text-gray-500 dark:text-gray-400 font-mono whitespace-nowrap"
                        >
                            {post.data.date.toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                            })}
                        </time>
                    </div>

                    {post.data.tags && (
                        <div class="flex gap-3 mt-1 text-xs font-mono text-gray-500 dark:text-gray-400">
                            {post.data.tags.map((t) => (
                                <span class={t === tag ? "text-rose-500 font-bold" : ""}>
                                    #{t}
                                </span>
                            ))}
                        </div>
                    )}
                </li>
            ))}
        </ul>
    </section>
</BaseLayout>